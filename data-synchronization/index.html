<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8">
<meta content="text/html; charset=utf-8" http-equiv="Content-Type">
<title>Data Synchronization - Datamover Operator</title>
<meta http-equiv="X-UA-Compatible" content="IE=edge">

<meta name="generator" content="mkdocs-1.6.1, mkdocs-gitbook-1.0.7">

<link rel="shortcut icon" href="../images/favicon.ico" type="image/x-icon">
<meta name="HandheldFriendly" content="true"/>
<meta name="viewport" content="width=device-width, initial-scale=1, user-scalable=no">
<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-status-bar-style" content="black">
<meta rel="next" href="" />
<link href="../css/style.min.css" rel="stylesheet"> 
</head>

<body>
<div class="book">
<div class="book-summary">
<div id="book-search-input" role="search">
<input type="text" placeholder="Type to search" />
</div> <!-- end of book-search-input -->

<nav role="navigation">
<ul class="summary">
<li>
<a href=".." target="_blank" class="custom-link">Datamover Operator</a>
</li>
<li class="divider"></li>
<li class="chapter" data-path="">
<a href="..">Welcome aboard!</a>
<li class="chapter" data-path="automatic-cleanup/">
<a href="../automatic-cleanup/">Automatic Cleanup</a>
<li class="chapter" data-path="container-image-configuration/">
<a href="../container-image-configuration/">Container Image Configuration</a>
<li class="chapter active" data-path="data-synchronization/">
<a href="./">Data Synchronization</a>
<li class="chapter" data-path="metrics-and-monitoring/">
<a href="../metrics-and-monitoring/">Metrics and Monitoring</a>
<li class="chapter" data-path="pvc-cloning/">
<a href="../pvc-cloning/">PVC Cloning</a>
<li class="chapter" data-path="timestamp-organization/">
<a href="../timestamp-organization/">Timestamp Organization</a>
<li class="divider"></li>



<li><a href="http://www.mkdocs.org">
Published with MkDocs
</a></li>

<li><a href="https://github.com/GitbookIO/theme-default">
Theme by GitBook
</a></li>
</ul>

</nav>

</div> <!-- end of book-summary -->

<div class="book-body">
<div class="body-inner">
<div class="book-header" role="navigation">

<!-- Title -->
<h1>
<i class="fa fa-circle-o-notch fa-spin"></i>
<a href="." ></a>
</h1>

</div> <!-- end of book-header -->

<div class="page-wrapper" tabindex="-1" role="main">
<div class="page-inner">
<div id="book-search-results">
<div class="search-noresults">

<section class="normal markdown-section">



<h1 id="data-synchronization">Data Synchronization</h1>
<p>This document covers the data synchronization capabilities of the DataMover Operator, including rclone integration and supported storage backends.</p>
<h2 id="overview">Overview</h2>
<p>The DataMover Operator uses <a href="https://rclone.org/">rclone</a> to synchronize data from cloned PVCs to remote storage backends. This provides a robust, well-tested solution for data transfer with support for numerous cloud and on-premises storage systems.</p>
<h2 id="rclone-integration">Rclone Integration</h2>
<h3 id="container-image">Container Image</h3>
<p>The operator uses a custom rclone container image: <code>ttl.sh/rclone_op:latest</code></p>
<p>This image includes:
- Latest rclone binary
- Custom entrypoint script for operator integration
- Support for timestamp prefix functionality
- Optimized for Kubernetes environments</p>
<h3 id="synchronization-process">Synchronization Process</h3>
<ol>
<li><strong>PVC Mounting</strong>: Cloned PVC is mounted at <code>/data/</code> in the rclone container</li>
<li><strong>Configuration</strong>: Storage credentials loaded from Kubernetes secrets</li>
<li><strong>Sync Execution</strong>: Rclone syncs <code>/data/</code> to configured remote destination</li>
<li><strong>Completion</strong>: Job completes with success/failure status</li>
</ol>
<h2 id="supported-storage-backends">Supported Storage Backends</h2>
<h3 id="minio">MinIO</h3>
<p><strong>Configuration</strong>:</p>
<pre><code class="language-yaml">AWS_ACCESS_KEY_ID: minio-access-key
AWS_SECRET_ACCESS_KEY: minio-secret-key
AWS_REGION: us-east-1
BUCKET_HOST: minio.example.com
BUCKET_NAME: backups
BUCKET_PORT: &quot;9000&quot;
TLS_HOST: &quot;false&quot;
</code></pre>
<h2 id="configuration-management">Configuration Management</h2>
<h3 id="secret-structure">Secret Structure</h3>
<p>Storage credentials are provided via Kubernetes secrets:</p>
<pre><code class="language-yaml">apiVersion: v1
kind: Secret
metadata:
  name: storage-credentials
type: Opaque
data:
  # Base64-encoded values
  AWS_ACCESS_KEY_ID: &lt;encoded-access-key&gt;
  AWS_SECRET_ACCESS_KEY: &lt;encoded-secret-key&gt;
  AWS_REGION: &lt;encoded-region&gt;
  BUCKET_HOST: &lt;encoded-host&gt;
  BUCKET_NAME: &lt;encoded-bucket&gt;
  BUCKET_PORT: &lt;encoded-port&gt;
  TLS_HOST: &lt;encoded-true-or-false&gt;
</code></pre>
<h3 id="environment-variables">Environment Variables</h3>
<p>The rclone container receives configuration through environment variables:</p>
<pre><code class="language-bash"># Storage backend configuration
AWS_ACCESS_KEY_ID=your-access-key
AWS_SECRET_ACCESS_KEY=your-secret-key
AWS_REGION=us-west-2
BUCKET_HOST=s3.amazonaws.com
BUCKET_NAME=my-backup-bucket
BUCKET_PORT=443
TLS_HOST=true

# Operator-specific configuration
ADD_TIMESTAMP_PREFIX=true  # Enable timestamp organization
</code></pre>
<h3 id="additional-environment-variables">Additional Environment Variables</h3>
<p>You can provide additional environment variables through the DataMover spec:</p>
<pre><code class="language-yaml">apiVersion: datamover.a-cup-of.coffee/v1alpha1
kind: DataMover
metadata:
  name: custom-sync
spec:
  sourcePvc: &quot;app-data&quot;
  secretName: &quot;storage-credentials&quot;
  additionalEnv:
    - name: &quot;RCLONE_TRANSFERS&quot;
      value: &quot;8&quot;
    - name: &quot;RCLONE_CHECKERS&quot;  
      value: &quot;16&quot;
    - name: &quot;CUSTOM_PATH_PREFIX&quot;
      value: &quot;production&quot;
</code></pre>
<h2 id="synchronization-features">Synchronization Features</h2>
<h3 id="timestamp-organization">Timestamp Organization</h3>
<p>When <code>addTimestampPrefix: true</code> is set, data is organized with timestamps:</p>
<pre><code>bucket/
├── 2024-08-06-143052/    # Timestamp folder
│   ├── app/
│   ├── data/
│   └── logs/
└── 2024-08-06-151225/    # Another backup
    ├── app/
    ├── data/
    └── logs/
</code></pre>
<p><strong>Format</strong>: <code>YYYY-MM-DD-HHMMSS</code></p>
<p><strong>Benefits</strong>:
- Point-in-time recovery
- Historical backup tracking
- Organized storage structure
- Easy cleanup of old backups</p>
<h3 id="incremental-synchronization">Incremental Synchronization</h3>
<p>Rclone performs incremental synchronization by default:</p>
<ul>
<li><strong>Changed files</strong>: Only modified files are transferred</li>
<li><strong>New files</strong>: New files are uploaded</li>
<li><strong>Deleted files</strong>: Files deleted from source are removed from destination</li>
<li><strong>Checksums</strong>: File integrity verified through checksums</li>
</ul>
<h3 id="metrics-collection">Metrics Collection</h3>
<p>The operator tracks synchronization metrics:</p>
<pre><code class="language-prometheus"># Sync operation counters
datamover_data_sync_operations_total{status=&quot;success&quot;}
datamover_data_sync_operations_total{status=&quot;failure&quot;}

# Phase duration tracking
datamover_phase_duration_seconds{phase=&quot;CreatingPod&quot;}
</code></pre>
<h2 id="performance-tuning">Performance Tuning</h2>
<h3 id="transfer-optimization">Transfer Optimization</h3>
<p>Optimize transfer performance based on your environment:</p>
<h4 id="high-bandwidth-networks">High Bandwidth Networks</h4>
<pre><code class="language-yaml">additionalEnv:
  - name: &quot;RCLONE_TRANSFERS&quot;
    value: &quot;8&quot;          # More parallel transfers
  - name: &quot;RCLONE_CHECKERS&quot;
    value: &quot;16&quot;         # More parallel checks
</code></pre>
<h4 id="limited-bandwidth-networks">Limited Bandwidth Networks</h4>
<pre><code class="language-yaml">additionalEnv:
  - name: &quot;RCLONE_TRANSFERS&quot;
    value: &quot;2&quot;          # Fewer parallel transfers
  - name: &quot;RCLONE_BW_LIMIT&quot;
    value: &quot;10M&quot;        # Bandwidth limit
</code></pre>
<h4 id="large-files">Large Files</h4>
<pre><code class="language-yaml">additionalEnv:
  - name: &quot;RCLONE_MULTI_THREAD_CUTOFF&quot;
    value: &quot;50M&quot;        # Multi-thread for files &gt; 50MB
  - name: &quot;RCLONE_MULTI_THREAD_STREAMS&quot;
    value: &quot;4&quot;          # 4 streams per large file
</code></pre>
<h3 id="resource-allocation">Resource Allocation</h3>
<p>Configure appropriate resources for sync jobs:</p>
<pre><code class="language-yaml"># In job template (operator configuration)
resources:
  requests:
    memory: &quot;512Mi&quot;     # Base memory for rclone
    cpu: &quot;200m&quot;         # Base CPU for operations
  limits:
    memory: &quot;2Gi&quot;       # Maximum memory (adjust for large files)
    cpu: &quot;1000m&quot;        # Maximum CPU for parallel operations
</code></pre>
<h2 id="error-handling">Error Handling</h2>
<h3 id="common-sync-errors">Common Sync Errors</h3>
<h4 id="1-authentication-failures">1. Authentication Failures</h4>
<p><strong>Error</strong>: <code>Failed to configure s3 backend: NoCredentialsErr</code></p>
<p><strong>Solutions</strong>:
- Verify secret credentials are correct
- Check credential encoding (base64)
- Validate IAM permissions for storage access</p>
<h4 id="2-network-connectivity-issues">2. Network Connectivity Issues</h4>
<p><strong>Error</strong>: <code>Failed to copy: connection timeout</code></p>
<p><strong>Solutions</strong>:
- Check network policies and firewall rules
- Verify storage endpoint accessibility
- Consider bandwidth limitations</p>
<h4 id="3-storage-permission-issues">3. Storage Permission Issues</h4>
<p><strong>Error</strong>: <code>AccessDenied: Access Denied</code></p>
<p><strong>Solutions</strong>:
- Verify bucket/container permissions
- Check IAM roles and policies
- Validate storage account access keys</p>
<h4 id="4-storage-space-issues">4. Storage Space Issues</h4>
<p><strong>Error</strong>: <code>No space left on device</code></p>
<p><strong>Solutions</strong>:
- Check storage quota limits
- Verify available space in destination
- Consider data compression options</p>
<h3 id="retry-strategy">Retry Strategy</h3>
<p>Rclone has built-in retry mechanisms:</p>
<ul>
<li><strong>File-level retries</strong>: Individual file transfer failures</li>
<li><strong>Operation retries</strong>: Overall operation failures  </li>
<li><strong>Exponential backoff</strong>: Increasing delays between retries</li>
</ul>
<p>Combined with Kubernetes Job retries, this provides robust error recovery.</p>
<h2 id="security-considerations">Security Considerations</h2>
<h3 id="credential-management">Credential Management</h3>
<ul>
<li>Store credentials only in Kubernetes secrets</li>
<li>Use least-privilege access policies</li>
<li>Rotate credentials regularly</li>
<li>Monitor credential usage</li>
</ul>
<h3 id="data-encryption">Data Encryption</h3>
<h4 id="in-transit">In Transit</h4>
<ul>
<li>Enable TLS for all connections (<code>TLS_HOST: "true"</code>)</li>
<li>Use encrypted storage endpoints</li>
<li>Verify certificate validation</li>
</ul>
<h4 id="at-rest">At Rest</h4>
<ul>
<li>Configure server-side encryption</li>
<li>Use customer-managed encryption keys when available</li>
<li>Enable storage backend encryption features</li>
</ul>
<h3 id="network-security">Network Security</h3>
<ul>
<li>Use private endpoints when possible</li>
<li>Implement network policies for job pods</li>
<li>Restrict egress traffic to required destinations</li>
<li>Monitor network access patterns</li>
</ul>
<h2 id="troubleshooting-synchronization">Troubleshooting Synchronization</h2>
<h3 id="diagnosis-commands">Diagnosis Commands</h3>
<pre><code class="language-bash"># Check rclone job status
kubectl get jobs -l app.kubernetes.io/created-by=datamover-operator

# View sync logs
kubectl logs job/verify-&lt;pvc-name&gt;

# Check secret configuration
kubectl get secret &lt;secret-name&gt; -o yaml

# Test storage connectivity
kubectl run rclone-test --rm -it --image=rclone/rclone -- rclone lsd remote:
</code></pre>
<h3 id="debug-configuration">Debug Configuration</h3>
<p>For debugging sync issues, add debug environment variables:</p>
<pre><code class="language-yaml">additionalEnv:
  - name: &quot;RCLONE_VERBOSE&quot;
    value: &quot;2&quot;          # Increase verbosity
  - name: &quot;RCLONE_LOG_LEVEL&quot;
    value: &quot;DEBUG&quot;      # Debug logging
  - name: &quot;RCLONE_DUMP&quot;
    value: &quot;headers&quot;    # Dump HTTP headers
</code></pre>
<h3 id="performance-analysis">Performance Analysis</h3>
<p>Monitor sync performance:</p>
<pre><code class="language-bash"># Check transfer statistics
kubectl logs job/verify-&lt;pvc-name&gt; | grep &quot;Transferred:&quot;

# Monitor resource usage
kubectl top pod &lt;rclone-pod-name&gt;

# Check storage backend performance
# (depends on storage backend monitoring tools)
</code></pre>
<h2 id="best-practices">Best Practices</h2>
<h3 id="1-configuration-management">1. Configuration Management</h3>
<ul>
<li>Use separate secrets for different environments</li>
<li>Validate configuration before creating DataMover resources</li>
<li>Document storage backend requirements</li>
</ul>
<h3 id="2-performance-optimization">2. Performance Optimization</h3>
<ul>
<li>Tune rclone settings for your environment</li>
<li>Monitor transfer performance and adjust accordingly</li>
<li>Consider storage backend limitations</li>
</ul>
<h3 id="3-security">3. Security</h3>
<ul>
<li>Follow principle of least privilege</li>
<li>Enable encryption in transit and at rest</li>
<li>Regular security audits of configurations</li>
</ul>
<h3 id="4-monitoring">4. Monitoring</h3>
<ul>
<li>Set up alerts for sync failures</li>
<li>Monitor sync duration trends</li>
<li>Track storage usage patterns</li>
</ul>
<h3 id="5-testing">5. Testing</h3>
<ul>
<li>Test sync operations with sample data</li>
<li>Validate backup integrity</li>
<li>Test restore procedures regularly</li>
</ul>


</section>
</div> <!-- end of search-noresults -->
<div class="search-results">
<div class="has-results">

<h1 class="search-results-title"><span class='search-results-count'></span> results matching "<span class='search-query'></span>"</h1>
<ul class="search-results-list"></ul>

</div> <!-- end of has-results -->
<div class="no-results">

<h1 class="search-results-title">No results matching "<span class='search-query'></span>"</h1>

</div> <!-- end of no-results -->
</div> <!-- end of search-results -->
</div> <!-- end of book-search-results -->

</div> <!-- end of page-inner -->
</div> <!-- end of page-wrapper -->

</div> <!-- end of body-inner -->

</div> <!-- end of book-body -->
<script src="../js/main.js"></script>
<script src="../search/main.js"></script>
<script src="../js/gitbook.min.js"></script>
<script src="../js/theme.min.js"></script>
</body>
</html>